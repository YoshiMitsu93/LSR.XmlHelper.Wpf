<Window
    x:Class="LSR.XmlHelper.Wpf.Views.XmlGuidesWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    Title="LSR XML Guides"
    Width="1120"
    Height="760"
    Background="{Binding Appearance.XmlGuidesWindowBackgroundBrush}"
    FontFamily="{Binding Appearance.UiFontFamily}"
    FontSize="{Binding Appearance.UiFontSize}"
    FontStyle="{Binding Appearance.UiFontStyle}"
    FontWeight="{Binding Appearance.UiFontWeight}"
    Foreground="{Binding Appearance.XmlGuidesWindowTextBrush}"
    Icon="/Assets/AppIcon.ico"
    WindowStartupLocation="CenterOwner">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />

        <Style TargetType="ToolTip">
            <Setter Property="Background" Value="{Binding DataContext.Appearance.XmlGuidesWindowControlBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.XmlGuidesWindowTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderBrush" Value="{Binding DataContext.Appearance.XmlGuidesWindowControlBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="10,8" />
        </Style>

        <Style TargetType="TextBox">
            <Setter Property="Background" Value="{Binding DataContext.Appearance.XmlGuidesWindowControlBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.XmlGuidesWindowTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderBrush" Value="{Binding DataContext.Appearance.XmlGuidesWindowControlBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
        </Style>

        <Style TargetType="ComboBox">
            <Setter Property="Background" Value="{Binding DataContext.Appearance.XmlGuidesWindowControlBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.XmlGuidesWindowFontPickerTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderBrush" Value="{Binding DataContext.Appearance.XmlGuidesWindowControlBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
        </Style>

        <Style TargetType="Button">
            <Setter Property="Padding" Value="12,6" />
            <Setter Property="MinWidth" Value="92" />
            <Setter Property="Margin" Value="0,0,8,0" />
            <Setter Property="Background" Value="{Binding DataContext.Appearance.XmlGuidesWindowButtonBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.XmlGuidesWindowButtonTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderBrush" Value="{Binding DataContext.Appearance.XmlGuidesWindowControlBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border x:Name="ButtonBorder"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                              VerticalAlignment="Center"
                                              TextElement.Foreground="{TemplateBinding Foreground}" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="ButtonBorder"
                                        Property="Background"
                                        Value="{Binding DataContext.Appearance.XmlGuidesWindowButtonHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                <Setter Property="Foreground"
                                        Value="{Binding DataContext.Appearance.XmlGuidesWindowButtonHoverTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                            </Trigger>
                            <Trigger Property="IsPressed" Value="True">
                                <Setter TargetName="ButtonBorder"
                                        Property="Background"
                                        Value="{Binding DataContext.Appearance.XmlGuidesWindowButtonHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                <Setter Property="Foreground"
                                        Value="{Binding DataContext.Appearance.XmlGuidesWindowButtonHoverTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                            </Trigger>
                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.5" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="PanelBorderStyle" TargetType="Border">
            <Setter Property="BorderBrush" Value="{Binding DataContext.Appearance.XmlGuidesWindowControlBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="4" />
        </Style>
    </Window.Resources>

    <Grid Margin="12">
        <Grid.RowDefinitions>
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="360" />
                <ColumnDefinition Width="12" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <Border
                Grid.Column="0"
                Padding="12"
                Style="{StaticResource PanelBorderStyle}">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top">
                        <TextBlock
                            FontSize="16"
                            FontWeight="SemiBold"
                            Text="Guides" />

                        <TextBox
                            Margin="0,10,0,10"
                            Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                            ToolTip="Search by title, category, summary, or guide content." />

                        <WrapPanel Margin="0,0,0,10">
                            <Button
                                Command="{Binding NewGuideCommand}"
                                Content="New"
                                ToolTip="Create a new guide you can edit and export." />
                            <Button
                                Command="{Binding ImportGuideCommand}"
                                Content="Import"
                                ToolTip="Import a .lsrguide.json file into your local guides." />
                            <Button
                                Command="{Binding ExportGuideCommand}"
                                Content="Export"
                                ToolTip="Export the selected guide as a .lsrguide.json file you can share." />
                        </WrapPanel>

                        <WrapPanel Margin="0,0,0,10">
                            <Button
                                Command="{Binding DuplicateBuiltInCommand}"
                                Content="Duplicate"
                                ToolTip="Create a copy of the selected guide so you can edit it." />
                            <Button
                                Command="{Binding ToggleEditModeCommand}"
                                Content="{Binding ToggleModeButtonText}"
                                ToolTip="Toggle edit mode for the selected guide." />
                        </WrapPanel>

                        <WrapPanel Margin="0,0,0,10" Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVis}}">
                            <Button
                                Command="{Binding SaveGuideCommand}"
                                Content="Save"
                                ToolTip="Save your local changes to this guide." />
                            <Button
                                Command="{Binding InsertImageCommand}"
                                Content="Insert image"
                                ToolTip="Copy an image into Guides\Images and insert an image marker into your guide content." />
                            <Button
                                Command="{Binding DeleteGuideCommand}"
                                Content="Delete"
                                ToolTip="Delete this guide from your local guides." />
                        </WrapPanel>

                        <TextBlock
                            Margin="0,0,0,6"
                            Opacity="0.75"
                            Text="Tip: Use [[img:filename.png]] on its own line to show an image. Use # and ## for headings, - for bullet points." />
                    </StackPanel>
                    <ListBox
                        Background="{Binding Appearance.XmlGuidesWindowGuidesListBackgroundBrush}"
                        BorderBrush="{Binding Appearance.XmlGuidesWindowControlBorderBrush}"
                        BorderThickness="1"
                        Foreground="{Binding Appearance.XmlGuidesWindowGuidesListTextBrush}"
                        ItemsSource="{Binding GuidesView}"
                        SelectedItem="{Binding SelectedGuide, Mode=TwoWay}">
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Background" Value="Transparent" />
                                <Setter Property="Foreground" Value="{Binding DataContext.Appearance.XmlGuidesWindowGuidesListTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                <Setter Property="Padding" Value="8,4" />
                                <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                                <Setter Property="Template">
                                    <Setter.Value>
                                        <ControlTemplate TargetType="ListBoxItem">
                                            <Border Background="{TemplateBinding Background}">
                                                <ContentPresenter />
                                            </Border>
                                        </ControlTemplate>
                                    </Setter.Value>
                                </Setter>
                                <Style.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter Property="Background" Value="{Binding DataContext.Appearance.XmlGuidesWindowGuidesListItemHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                        <Setter Property="Foreground" Value="{Binding DataContext.Appearance.XmlGuidesWindowGuidesListItemHoverTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter Property="Background" Value="{Binding DataContext.Appearance.XmlGuidesWindowGuidesListItemSelectedBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                        <Setter Property="Foreground" Value="{Binding DataContext.Appearance.XmlGuidesWindowGuidesListItemSelectedTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                    </Trigger>
                                </Style.Triggers>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="0,8,0,8">
                                    <TextBlock
                                        FontWeight="SemiBold"
                                        Text="{Binding Title}"
                                        TextWrapping="Wrap" />
                                    <TextBlock
                                        Opacity="0.75"
                                        Text="{Binding Summary}"
                                        TextWrapping="Wrap" />
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>

            <GridSplitter
                Grid.Column="1"
                Width="12"
                HorizontalAlignment="Stretch"
                VerticalAlignment="Stretch"
                ShowsPreview="True" />

            <Border
                Grid.Column="2"
                Padding="14"
                Style="{StaticResource PanelBorderStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="12" />
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <Grid Grid.Row="0" Margin="0,0,0,8">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel
                            Grid.Column="0"
                            VerticalAlignment="Center"
                            Orientation="Horizontal">
                            <TextBlock
                                FontSize="18"
                                FontWeight="SemiBold"
                                Text="{Binding SelectedGuideTitle}" />

                            <TextBlock
                                Margin="12,0,0,0"
                                Opacity="0.7"
                                Text="{Binding SelectedGuideSourceLabel}" />

                            <TextBlock
                                Margin="12,0,0,0"
                                Opacity="0.7"
                                Text="{Binding EditModeLabel}" />
                        </StackPanel>

                        <StackPanel
                            Grid.Column="1"
                            HorizontalAlignment="Right"
                            VerticalAlignment="Center"
                            Orientation="Horizontal">
                            <TextBlock
                                Margin="0,0,6,0"
                                Opacity="0.75"
                                Text="Font" />
                            <ComboBox
                                Width="160"
                                ItemsSource="{Binding GuideFontFamilies}"
                                SelectedItem="{Binding GuideFontFamily}" />
                            <TextBlock
                                Margin="10,0,6,0"
                                Opacity="0.75"
                                Text="Size" />
                            <ComboBox
                                Width="70"
                                ItemsSource="{Binding GuideFontSizes}"
                                SelectedItem="{Binding GuideFontSize}" />
                            <TextBlock
                                Margin="10,0,6,0"
                                Opacity="0.75"
                                Text="Zoom" />
                            <Slider
                                Width="120"
                                Maximum="300"
                                Minimum="50"
                                Value="{Binding GuideZoom}" />
                            <TextBlock
                                Margin="6,0,0,0"
                                Opacity="0.75"
                                Text="{Binding GuideZoom, StringFormat={}{0:0}%}" />
                        </StackPanel>
                    </Grid>

                    <Grid Grid.Row="2">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" Visibility="{Binding IsEditMode, Converter={StaticResource BoolToVis}}">
                            <StackPanel>
                                <TextBlock Margin="0,0,0,4" Text="Guide title" />
                                <TextBox Text="{Binding Title, UpdateSourceTrigger=PropertyChanged}" ToolTip="A short title that explains what this guide teaches." />

                                <TextBlock Margin="0,12,0,4" Text="Category" />
                                <TextBox Text="{Binding Category, UpdateSourceTrigger=PropertyChanged}" ToolTip="Groups guides in the list. Example: Gangs, Vehicles, Crime, Police." />

                                <TextBlock Margin="0,12,0,4" Text="Short summary" />
                                <TextBox
                                    Height="90"
                                    AcceptsReturn="True"
                                    Text="{Binding Summary, UpdateSourceTrigger=PropertyChanged}"
                                    TextWrapping="Wrap"
                                    ToolTip="A quick overview shown in the list."
                                    VerticalScrollBarVisibility="Auto" />

                                <WrapPanel Margin="0,12,0,6" Orientation="Horizontal">
                                    <Button
                                        Width="34"
                                        Height="26"
                                        MinWidth="0"
                                        Margin="0,0,6,0"
                                        Padding="0"
                                        Click="Bold_Click"
                                        Content="B"
                                        FontWeight="Bold"
                                        ToolTip="Bold (wrap selection with **)" />
                                    <Button
                                        Width="34"
                                        Height="26"
                                        MinWidth="0"
                                        Margin="0,0,6,0"
                                        Padding="0"
                                        Click="Italic_Click"
                                        Content="I"
                                        FontStyle="Italic"
                                        ToolTip="Italic (wrap selection with *)" />
                                    <Button
                                        Width="34"
                                        Height="26"
                                        MinWidth="0"
                                        Margin="0,0,6,0"
                                        Padding="0"
                                        Click="Underline_Click"
                                        ToolTip="Underline (wrap selection with __)">
                                        <TextBlock Text="U" TextDecorations="Underline" />
                                    </Button>
                                    <Button
                                        Width="70"
                                        Height="26"
                                        MinWidth="0"
                                        Margin="6,0,0,0"
                                        Padding="0"
                                        Click="Bullets_Click"
                                        Content="Bullets"
                                        ToolTip="Convert selected lines into bullet points (- )" />
                                </WrapPanel>

                                <TextBox
                                    x:Name="BodyTextBox"
                                    Height="460"
                                    AcceptsReturn="True"
                                    FontFamily="{Binding GuideFontFamily}"
                                    FontSize="{Binding GuideFontSize}"
                                    PreviewKeyDown="BodyTextBox_PreviewKeyDown"
                                    Text="{Binding Body, UpdateSourceTrigger=PropertyChanged}"
                                    TextWrapping="Wrap"
                                    ToolTip="Write the steps. Use headings (#), bullets (-), and images. Tip: Ctrl+V to paste an image."
                                    VerticalScrollBarVisibility="Auto" />
                            </StackPanel>
                        </ScrollViewer>

                        <FlowDocumentScrollViewer
                            Document="{Binding GuideDocument}"
                            FontFamily="{Binding GuideFontFamily}"
                            FontSize="{Binding GuideFontSize}"
                            MaxZoom="300"
                            MinZoom="50"
                            PreviewMouseWheel="GuideViewer_PreviewMouseWheel"
                            VerticalScrollBarVisibility="Auto"
                            Zoom="{Binding GuideZoom}"
                            ZoomIncrement="10">
                            <FlowDocumentScrollViewer.Style>
                                <Style TargetType="FlowDocumentScrollViewer">
                                    <Setter Property="Visibility" Value="Visible" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsEditMode}" Value="True">
                                            <Setter Property="Visibility" Value="Collapsed" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </FlowDocumentScrollViewer.Style>
                        </FlowDocumentScrollViewer>
                    </Grid>
                </Grid>
            </Border>
        </Grid>

        <DockPanel
            Grid.Row="1"
            Margin="0,12,0,0"
            LastChildFill="False">
            <TextBlock
                VerticalAlignment="Center"
                DockPanel.Dock="Left"
                Opacity="0.75"
                Text="{Binding IsDirty, StringFormat=Unsaved changes: {0}}" />

            <Button
                Width="100"
                Click="Close_Click"
                Content="Close"
                DockPanel.Dock="Right"
                IsCancel="True"
                ToolTip="Close this window." />
        </DockPanel>
    </Grid>
</Window>
