<Window x:Class="LSR.XmlHelper.Wpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:infra="clr-namespace:LSR.XmlHelper.Wpf.Infrastructure"
        xmlns:avalonedit="http://icsharpcode.net/sharpdevelop/avalonedit"
        xmlns:vm="clr-namespace:LSR.XmlHelper.Wpf.ViewModels"
        mc:Ignorable="d"
        Title="{Binding Title}"
        Height="450"
        Width="900"
        FontFamily="{Binding Appearance.UiFontFamily}"
        FontSize="{Binding Appearance.UiFontSize}"
        FontWeight="{Binding Appearance.UiFontWeight}"
        FontStyle="{Binding Appearance.UiFontStyle}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <infra:InverseBooleanToVisibilityConverter x:Key="InverseBoolToVis" />

        <Style TargetType="{x:Type Menu}"> 
            <Setter Property="Background" Value="{Binding Appearance.MenuBackgroundBrush}" />
            <Setter Property="Foreground" Value="{Binding Appearance.MenuTextBrush}" />
        </Style>

        <Style TargetType="{x:Type MenuItem}">
            <Setter Property="Foreground" Value="{Binding Appearance.MenuTextBrush}" />
            <Setter Property="Background" Value="{Binding Appearance.MenuBackgroundBrush}" />
            <Setter Property="Padding" Value="8,3" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type MenuItem}">
                        <Grid SnapsToDevicePixels="True">
                            <Border x:Name="HeaderBorder"
                                    Background="{TemplateBinding Background}"
                                    Padding="{TemplateBinding Padding}">
                                <ContentPresenter ContentSource="Header"
                                                  RecognizesAccessKey="True"
                                                  VerticalAlignment="Center"
                                                  HorizontalAlignment="Left" />
                            </Border>

                            <Popup x:Name="Popup"
                                   IsOpen="{TemplateBinding IsSubmenuOpen}"
                                   Placement="Bottom"
                                   AllowsTransparency="True"
                                   Focusable="False"
                                   PopupAnimation="Fade">
                                <Border Background="{Binding DataContext.Appearance.MenuBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}"
                                        BorderBrush="{Binding DataContext.Appearance.GridBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}"
                                        BorderThickness="1"
                                        SnapsToDevicePixels="True">
                                    <ScrollViewer CanContentScroll="True"
                                                  VerticalScrollBarVisibility="Auto"
                                                  HorizontalScrollBarVisibility="Disabled">
                                        <StackPanel IsItemsHost="True"
                                                    KeyboardNavigation.DirectionalNavigation="Cycle" />
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="HeaderBorder"
                                        Property="Background"
                                        Value="{Binding DataContext.Appearance.TreeItemHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                            </Trigger>

                            <Trigger Property="IsSubmenuOpen" Value="True">
                                <Setter TargetName="HeaderBorder"
                                        Property="Background"
                                        Value="{Binding DataContext.Appearance.TreeItemSelectedBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                            </Trigger>

                            <Trigger Property="Role" Value="SubmenuHeader">
                                <Setter TargetName="Popup" Property="Placement" Value="Right" />
                            </Trigger>

                            <Trigger Property="Role" Value="SubmenuItem">
                                <Setter Property="Foreground"
                                        Value="{Binding DataContext.Appearance.MenuTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style TargetType="{x:Type DataGrid}">
            <Setter Property="infra:ScrollViewerMouseWheelBehavior.Enable" Value="True" />
            <Setter Property="Background" Value="{Binding DataContext.Appearance.GridBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.GridTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderBrush" Value="{Binding DataContext.Appearance.GridBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="HorizontalGridLinesBrush" Value="{Binding DataContext.Appearance.GridLinesBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="VerticalGridLinesBrush" Value="{Binding DataContext.Appearance.GridLinesBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="GridLinesVisibility" Value="All" />
            <Setter Property="HeadersVisibility" Value="Column" />
        </Style>

        <Style TargetType="{x:Type DataGridColumnHeader}">
            <Setter Property="Background" Value="{Binding DataContext.Appearance.GridHeaderBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.GridHeaderTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderBrush" Value="{Binding DataContext.Appearance.GridBorderBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderThickness" Value="0,0,1,1" />
        </Style>

        <Style TargetType="{x:Type DataGridRow}">
            <Setter Property="Background" Value="{Binding DataContext.Appearance.GridBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.GridTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="{Binding DataContext.Appearance.GridRowHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{Binding DataContext.Appearance.GridRowSelectedBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="{x:Type DataGridCell}">
            <Setter Property="BorderBrush" Value="{Binding DataContext.Appearance.GridLinesBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="BorderThickness" Value="0,0,1,1" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.GridTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="FocusVisualStyle" Value="{x:Null}" />
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="{Binding DataContext.Appearance.GridCellSelectedBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                    <Setter Property="Foreground" Value="{Binding DataContext.Appearance.GridCellSelectedTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
                <Trigger Property="IsKeyboardFocusWithin" Value="True">
                    <Setter Property="Background" Value="{Binding DataContext.Appearance.GridCellSelectedBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                    <Setter Property="Foreground" Value="{Binding DataContext.Appearance.GridCellSelectedTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="{x:Type Expander}">
            <Setter Property="Foreground" Value="{Binding Appearance.TextBrush}" />
        </Style>

        <Style TargetType="{x:Type TreeView}">
            <Setter Property="Background" Value="{Binding Appearance.TreeBackgroundBrush}" />
            <Setter Property="Foreground" Value="{Binding Appearance.TreeTextBrush}" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>

        <Style x:Key="XmlTreeItemStyle" TargetType="{x:Type TreeViewItem}">
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.TreeTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Padding" Value="2,1" />
            <Setter Property="HorizontalContentAlignment" Value="Stretch" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />

            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type TreeViewItem}">
                        <Grid SnapsToDevicePixels="True">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition />
                            </Grid.RowDefinitions>

                            <Border Grid.Row="0"
                                    Grid.ColumnSpan="2"
                                    Background="{TemplateBinding Background}"
                                    CornerRadius="2"
                                    SnapsToDevicePixels="True"
                                    Width="{Binding ActualWidth, RelativeSource={RelativeSource AncestorType=TreeView}}"
                                    HorizontalAlignment="Left" />

                            <ToggleButton x:Name="Expander"
                                          Grid.Row="0"
                                          Grid.Column="0"
                                          Width="16"
                                          Height="16"
                                          Margin="0,0,2,0"
                                          IsChecked="{Binding IsExpanded, RelativeSource={RelativeSource TemplatedParent}}"
                                          ClickMode="Press"
                                          Focusable="False"
                                          Background="Transparent"
                                          BorderThickness="0">
                                <Path x:Name="Arrow"
                                      Width="8"
                                      Height="8"
                                      Fill="{TemplateBinding Foreground}"
                                      Data="M 0 0 L 8 4 L 0 8 Z"
                                      RenderTransformOrigin="0.5,0.5">
                                    <Path.RenderTransform>
                                        <RotateTransform Angle="0" />
                                    </Path.RenderTransform>
                                </Path>
                            </ToggleButton>

                            <ContentPresenter Grid.Row="0"
                                              Grid.Column="1"
                                              Margin="{TemplateBinding Padding}"
                                              ContentSource="Header"
                                              HorizontalAlignment="Stretch"
                                              VerticalAlignment="Center"
                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                              TextElement.Foreground="{TemplateBinding Foreground}" />

                            <ItemsPresenter x:Name="ItemsHost"
                                            Grid.Row="1"
                                            Grid.Column="1"
                                            Margin="18,0,0,0"
                                            Visibility="Collapsed" />

                        </Grid>

                        <ControlTemplate.Triggers>
                            <Trigger Property="IsExpanded" Value="True">
                                <Setter TargetName="ItemsHost" Property="Visibility" Value="Visible" />
                                <Setter TargetName="Arrow" Property="RenderTransform">
                                    <Setter.Value>
                                        <RotateTransform Angle="90" />
                                    </Setter.Value>
                                </Setter>
                            </Trigger>

                            <Trigger Property="HasItems" Value="False">
                                <Setter TargetName="Expander" Property="Visibility" Value="Hidden" />
                            </Trigger>

                            <Trigger Property="IsEnabled" Value="False">
                                <Setter Property="Opacity" Value="0.55" />
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>

            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background"
                            Value="{Binding DataContext.Appearance.TreeItemHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>

                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background"
                            Value="{Binding DataContext.Appearance.TreeItemSelectedBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="{x:Type ListBox}">
            <Setter Property="Background" Value="{Binding Appearance.TreeBackgroundBrush}" />
            <Setter Property="Foreground" Value="{Binding Appearance.HeaderTextBrush}" />
            <Setter Property="BorderThickness" Value="0" />
        </Style>

        <Style TargetType="{x:Type ListBoxItem}">
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.HeaderTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Padding" Value="4,2" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background"
                            Value="{Binding DataContext.Appearance.TreeItemHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background"
                            Value="{Binding DataContext.Appearance.TreeItemSelectedBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="Pane2ListBoxStyle"
               TargetType="{x:Type ListBox}"
               BasedOn="{StaticResource {x:Type ListBox}}">
            <Setter Property="Background" Value="{Binding Appearance.SelectorBackgroundBrush}" />
        </Style>

        <Style x:Key="Pane2ListBoxItemStyle"
               TargetType="{x:Type ListBoxItem}"
               BasedOn="{StaticResource {x:Type ListBoxItem}}">
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.HeaderTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Padding" Value="4,2" />
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background"
                            Value="{Binding DataContext.Appearance.TreeItemHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background"
                            Value="{Binding DataContext.Appearance.TreeItemSelectedBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="{x:Type ComboBoxItem}">
            <Setter Property="Background" Value="{Binding DataContext.Appearance.TreeBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.HeaderTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Padding" Value="6,3" />
            <Style.Triggers>
                <Trigger Property="IsHighlighted" Value="True">
                    <Setter Property="Background"
                            Value="{Binding DataContext.Appearance.TreeItemHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="{x:Type ComboBox}">
            <Setter Property="Background" Value="{Binding Appearance.TreeBackgroundBrush}" />
            <Setter Property="Foreground" Value="{Binding Appearance.HeaderTextBrush}" />
            <Setter Property="BorderBrush" Value="{Binding Appearance.BackgroundBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="MinHeight" Value="26" />
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled" />
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto" />
        </Style>

        <Style x:Key="Pane2ComboBoxStyle"
               TargetType="{x:Type ComboBox}"
               BasedOn="{StaticResource {x:Type ComboBox}}">
            <Setter Property="Background" Value="{Binding Appearance.SelectorBackgroundBrush}" />
        </Style>

        <Style x:Key="Pane2ComboBoxItemStyle"
               TargetType="{x:Type ComboBoxItem}"
               BasedOn="{StaticResource {x:Type ComboBoxItem}}">
            <Setter Property="Background" Value="{Binding DataContext.Appearance.SelectorBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Foreground" Value="{Binding DataContext.Appearance.HeaderTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
            <Setter Property="Padding" Value="6,3" />
            <Style.Triggers>
                <Trigger Property="IsHighlighted" Value="True">
                    <Setter Property="Background"
                            Value="{Binding DataContext.Appearance.TreeItemHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style TargetType="{x:Type ScrollViewer}">
            <Setter Property="Background" Value="Transparent" />
        </Style>

        <HierarchicalDataTemplate DataType="{x:Type vm:XmlFolderNode}" ItemsSource="{Binding Children}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="📁" Margin="0,0,6,0" />
                <TextBlock Text="{Binding Name}" />
            </StackPanel>
        </HierarchicalDataTemplate>

        <DataTemplate DataType="{x:Type vm:XmlFileNode}">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="📄" Margin="0,0,6,0" />
                <TextBlock Text="{Binding Name}" />
            </StackPanel>
        </DataTemplate>

        <DataTemplate DataType="{x:Type vm:XmlFriendlyFieldGroupViewModel}">
            <Expander Header="{Binding Title}"
                      IsExpanded="{Binding IsExpanded}"
                      Margin="0,0,0,6">
                <DataGrid ItemsSource="{Binding Fields}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          SelectionUnit="FullRow">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Field"
                                            Binding="{Binding Name}"
                                            IsReadOnly="True"
                                            Width="260">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="{x:Type TextBlock}">
                                    <Setter Property="Foreground"
                                            Value="{Binding DataContext.Appearance.FieldColumnTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="Value"
                                            Binding="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                            Width="*">

                            <DataGridTextColumn.CellStyle>
                                <Style TargetType="{x:Type DataGridCell}"
                                            BasedOn="{StaticResource {x:Type DataGridCell}}">
                                    <Setter Property="Background"
                                            Value="{Binding DataContext.Appearance.ValueColumnBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=DataGridRow}}" Value="True">
                                            <Setter Property="Background"
                                            Value="{Binding DataContext.Appearance.GridRowHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </DataGridTextColumn.CellStyle>

                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="{x:Type TextBlock}">
                                    <Setter Property="Foreground"
                                            Value="{Binding DataContext.Appearance.ValueColumnTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>

                            <DataGridTextColumn.EditingElementStyle>
                                <Style TargetType="{x:Type TextBox}">
                                    <Setter Property="Foreground"
                                            Value="{Binding DataContext.Appearance.ValueColumnTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                    <Setter Property="Background"
                                            Value="{Binding DataContext.Appearance.ValueColumnBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                    <Setter Property="BorderThickness" Value="0" />
                                </Style>
                            </DataGridTextColumn.EditingElementStyle>

                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Expander>
        </DataTemplate>

        <DataTemplate DataType="{x:Type vm:XmlFriendlyLookupGroupViewModel}">
            <Expander Header="{Binding Title}"
                      IsExpanded="{Binding IsExpanded}"
                      Margin="0,0,0,6">
                <DataGrid ItemsSource="{Binding Items}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          SelectionUnit="FullRow">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Item"
                                            Binding="{Binding Item}"
                                            IsReadOnly="True"
                                            Width="220">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="{x:Type TextBlock}">
                                    <Setter Property="Foreground"
                                            Value="{Binding DataContext.Appearance.FieldColumnTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="Field"
                                            Binding="{Binding Field}"
                                            IsReadOnly="True"
                                            Width="160">
                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="{x:Type TextBlock}">
                                    <Setter Property="Foreground"
                                            Value="{Binding DataContext.Appearance.FieldColumnTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>
                        </DataGridTextColumn>

                        <DataGridTextColumn Header="Value"
                                            Binding="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                            Width="*">

                            <DataGridTextColumn.CellStyle>
                                <Style TargetType="{x:Type DataGridCell}"
                                            BasedOn="{StaticResource {x:Type DataGridCell}}">
                                    <Setter Property="Background"
                                            Value="{Binding DataContext.Appearance.ValueColumnBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsMouseOver, RelativeSource={RelativeSource AncestorType=DataGridRow}}" Value="True">
                                            <Setter Property="Background"
                                            Value="{Binding DataContext.Appearance.GridRowHoverBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>

                            </DataGridTextColumn.CellStyle>

                            <DataGridTextColumn.ElementStyle>
                                <Style TargetType="{x:Type TextBlock}">
                                    <Setter Property="Foreground"
                                            Value="{Binding DataContext.Appearance.ValueColumnTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                </Style>
                            </DataGridTextColumn.ElementStyle>

                            <DataGridTextColumn.EditingElementStyle>
                                <Style TargetType="{x:Type TextBox}">
                                    <Setter Property="Foreground"
                                            Value="{Binding DataContext.Appearance.ValueColumnTextBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                    <Setter Property="Background"
                                            Value="{Binding DataContext.Appearance.ValueColumnBackgroundBrush, RelativeSource={RelativeSource AncestorType=Window}}" />
                                    <Setter Property="BorderThickness" Value="0" />
                                </Style>
                            </DataGridTextColumn.EditingElementStyle>

                        </DataGridTextColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Expander>
        </DataTemplate>

    </Window.Resources>

    <DockPanel LastChildFill="True"
               Background="{Binding Appearance.BackgroundBrush}">

        <Menu DockPanel.Dock="Top">
            <MenuItem Header="_File">
                <MenuItem Header="_Open Folder..."
                          ToolTip="Pick the folder that contains your XML files."
                          Command="{Binding OpenCommand}" />
                <Separator />
                <MenuItem Header="_Save"
                          ToolTip="Save changes to the current XML file (backup is created when saving edits)."
                          IsEnabled="{Binding IsDirty}"
                          Command="{Binding SaveCommand}" />
                <MenuItem Header="Save _As..."
                          ToolTip="Save changes to a new file path."
                          IsEnabled="{Binding IsDirty}"
                          Command="{Binding SaveAsCommand}" />
                <Separator />
                <MenuItem Header="E_xit"
                          ToolTip="Close the application."
                          Click="Exit_Click" />
            </MenuItem>

            <MenuItem Header="_Edit">
                <MenuItem Header="_Format"
                          ToolTip="Format (pretty-print) the XML."
                          Command="{Binding FormatCommand}" />
                <MenuItem Header="_Validate"
                          ToolTip="Validate that the XML is well-formed."
                          Command="{Binding ValidateCommand}" />
                <Separator />
                <MenuItem Header="_Clear"
                          ToolTip="Clear the current selection and editor."
                          Command="{Binding ClearCommand}" />
            </MenuItem>

            <MenuItem Header="_View">
                <MenuItem Header="_Folders"
                          ToolTip="Show files in a folder tree."
                          IsCheckable="True"
                          IsChecked="{Binding IsFoldersMode}" />
                <MenuItem Header="_Flat"
                          ToolTip="Show all XML files in a single list."
                          IsCheckable="True"
                          IsChecked="{Binding IsFlatMode}" />
                <Separator />
                <MenuItem Header="_Appearance..."
                          ToolTip="Customize fonts and colors."
                          Command="{Binding OpenAppearanceCommand}" />
                <Separator />
                <MenuItem Header="Include _subfolders"
                          ToolTip="Include XML files from subfolders when scanning."
                          IsCheckable="True"
                          IsChecked="{Binding IncludeSubfolders}" />
                <MenuItem Header="_Friendly view"
                          ToolTip="Toggle the structured editor view for supported XML formats."
                          IsCheckable="True"
                          IsEnabled="{Binding HasFriendlyView}"
                          IsChecked="{Binding IsFriendlyView}" />
                <MenuItem Header="_Dark mode"
                          ToolTip="Toggle dark theme for the editor and friendly view."
                          IsCheckable="True"
                          IsChecked="{Binding IsDarkMode}" />
                <Separator />
                <MenuItem Header="Open _Current XML Folder"
                          ToolTip="Open the folder of the currently selected XML file."
                          Click="OpenCurrentXmlFolder_Click" />
                <MenuItem Header="Open _Helper Root Folder"
                          ToolTip="Open the helper root folder that contains backup and related folders."
                          Click="OpenHelperRootFolder_Click" />
                <MenuItem Header="Open _Backups Folder"
                          ToolTip="Open the folder where backups are stored."
                          Click="OpenBackupsFolder_Click" />
            </MenuItem>

            <MenuItem Header="_Help">
                <MenuItem Header="_About"
                          ToolTip="Show information about this app."
                          Click="About_Click" />
            </MenuItem>
        </Menu>

        <StackPanel DockPanel.Dock="Top" Margin="8" Orientation="Vertical">
            <WrapPanel>
                <Button Content="Open Folder"
                        MinWidth="100"
                        Margin="0,0,8,0"
                        ToolTip="Pick the folder that contains your XML files."
                        Command="{Binding OpenCommand}" />

                <Button Content="Format"
                        MinWidth="70"
                        Margin="0,0,8,0"
                        ToolTip="Format (pretty-print) the XML."
                        Command="{Binding FormatCommand}" />

                <Button Content="Validate"
                        MinWidth="70"
                        Margin="0,0,8,0"
                        ToolTip="Validate that the XML is well-formed."
                        Command="{Binding ValidateCommand}" />

                <Button Content="Save"
                        MinWidth="70"
                        Margin="0,0,8,0"
                        ToolTip="Save changes to the current XML file (backup is created when saving edits)."
                        IsEnabled="{Binding IsDirty}"
                        Command="{Binding SaveCommand}" />

                <Button Content="Save As..."
                        MinWidth="90"
                        Margin="0,0,8,0"
                        ToolTip="Save changes to a new file path."
                        IsEnabled="{Binding IsDirty}"
                        Command="{Binding SaveAsCommand}" />

                <Button Content="Clear"
                        MinWidth="70"
                        Margin="0,0,8,0"
                        ToolTip="Clear the current selection and editor."
                        Command="{Binding ClearCommand}" />
            </WrapPanel>

            <WrapPanel Margin="0,6,0,0">
                <WrapPanel.Resources>
                    <Style TargetType="{x:Type TextBlock}">
                        <Setter Property="Foreground" Value="{Binding Appearance.GridTextBrush}" />
                    </Style>
                    <Style TargetType="{x:Type RadioButton}">
                        <Setter Property="Foreground" Value="{Binding Appearance.GridTextBrush}" />
                    </Style>
                    <Style TargetType="{x:Type CheckBox}">
                        <Setter Property="Foreground" Value="{Binding Appearance.GridTextBrush}" />
                    </Style>
                </WrapPanel.Resources>

                <TextBlock Text="View:" VerticalAlignment="Center" Margin="0,0,6,0" />

                <RadioButton Content="Folders"
                             VerticalAlignment="Center"
                             Margin="0,0,8,0"
                             ToolTip="Show files in a folder tree."
                             IsChecked="{Binding IsFoldersMode}" />

                <RadioButton Content="Flat"
                             VerticalAlignment="Center"
                             Margin="0,0,16,0"
                             ToolTip="Show all XML files in a single list."
                             IsChecked="{Binding IsFlatMode}" />

                <CheckBox Content="Include subfolders"
                          VerticalAlignment="Center"
                          Margin="0,0,16,0"
                          ToolTip="Include XML files from subfolders when scanning."
                          IsChecked="{Binding IncludeSubfolders}" />

                <CheckBox Content="Friendly view"
                          VerticalAlignment="Center"
                          Margin="0,0,16,0"
                          ToolTip="Toggle the structured editor view for supported XML formats."
                          IsEnabled="{Binding HasFriendlyView}"
                          IsChecked="{Binding IsFriendlyView}" />

                <CheckBox Content="Dark mode"
                          VerticalAlignment="Center"
                          ToolTip="Toggle dark theme for the editor and friendly view."
                          IsChecked="{Binding IsDarkMode}" />
            </WrapPanel>
        </StackPanel>

        <StatusBar DockPanel.Dock="Bottom">
            <TextBlock Text="{Binding Status}" />
        </StatusBar>

        <Grid Margin="8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" />
                <ColumnDefinition Width="6" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <Border Grid.Column="0"
                    BorderThickness="1"
                    BorderBrush="{Binding Appearance.BackgroundBrush}"
                    Padding="6"
                    Background="{Binding Appearance.TreeBackgroundBrush}">
                <Grid Background="{Binding Appearance.TreeBackgroundBrush}">
                    <TreeView ItemsSource="{Binding XmlTree}"
                              ItemContainerStyle="{StaticResource XmlTreeItemStyle}"
                              HorizontalContentAlignment="Stretch"
                              SelectedItemChanged="TreeView_SelectedItemChanged"
                              KeyDown="TreeView_KeyDown"
                              Visibility="{Binding IsFoldersMode, Converter={StaticResource BoolToVis}}" />

                    <ListBox ItemsSource="{Binding XmlFiles}"
                             SelectedItem="{Binding SelectedXmlFile}"
                             DisplayMemberPath="DisplayPath"
                             Visibility="{Binding IsFlatMode, Converter={StaticResource BoolToVis}}" />
                </Grid>
            </Border>

            <GridSplitter Grid.Column="1"
                          HorizontalAlignment="Stretch"
                          VerticalAlignment="Stretch"
                          ResizeBehavior="PreviousAndNext"
                          ResizeDirection="Columns"
                          Background="{Binding Appearance.BackgroundBrush}" />

            <Grid Grid.Column="2">
                <Grid Visibility="{Binding Appearance.IsFriendlyView, Converter={StaticResource BoolToVis}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="280" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <DockPanel Grid.Column="0"
                               Margin="0,0,8,0"
                               Background="{Binding Appearance.SelectorBackgroundBrush}">

                        <ComboBox DockPanel.Dock="Top"
                                  ItemsSource="{Binding FriendlyCollections}"
                                  SelectedItem="{Binding SelectedFriendlyCollection}"
                                  DisplayMemberPath="Title"
                                  Margin="0,0,0,8"
                                  Style="{StaticResource Pane2ComboBoxStyle}"
                                  ItemContainerStyle="{StaticResource Pane2ComboBoxItemStyle}" />

                        <ListBox ItemsSource="{Binding SelectedFriendlyCollection.Entries}"
                                 SelectedItem="{Binding SelectedFriendlyEntry}"
                                 DisplayMemberPath="Display"
                                 Style="{StaticResource Pane2ListBoxStyle}"
                                 ItemContainerStyle="{StaticResource Pane2ListBoxItemStyle}" />
                    </DockPanel>

                    <Border Grid.Column="1"
                            Background="{Binding Appearance.BackgroundBrush}"
                            BorderBrush="{Binding Appearance.GridBorderBrush}"
                            BorderThickness="1">
                        <ScrollViewer VerticalScrollBarVisibility="Auto"
                                      HorizontalScrollBarVisibility="Disabled"
                                      Background="{Binding Appearance.BackgroundBrush}">
                            <ItemsControl ItemsSource="{Binding FriendlyGroups}" />
                        </ScrollViewer>
                    </Border>
                </Grid>

                <avalonedit:TextEditor x:Name="XmlEditor"
                                       Visibility="{Binding Appearance.IsFriendlyView, Converter={StaticResource InverseBoolToVis}}"
                                       ShowLineNumbers="True"
                                       FontFamily="{Binding Appearance.EditorFontFamily}"
                                       FontSize="{Binding Appearance.EditorFontSize}"
                                       FontWeight="{Binding Appearance.EditorFontWeight}"
                                       FontStyle="{Binding Appearance.EditorFontStyle}"
                                       HorizontalScrollBarVisibility="Auto"
                                       VerticalScrollBarVisibility="Auto"
                                       Background="{Binding Appearance.EditorBackgroundBrush}"
                                       Foreground="{Binding Appearance.EditorTextBrush}"
                                       infra:AvalonEditThemeBehavior.TextAreaBackground="{Binding Appearance.EditorBackgroundBrush}"
                                       infra:AvalonEditThemeBehavior.TextAreaForeground="{Binding Appearance.EditorTextBrush}"
                                       infra:AvalonEditTextBinding.Text="{Binding XmlText, Mode=TwoWay}" />
            </Grid>
        </Grid>
    </DockPanel>
</Window>